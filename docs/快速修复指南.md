# ⚡ 工作流不显示 - 快速修复指南

## 🚨 最重要的步骤

### 1️⃣ 重新编译扩展

```bash
npm run compile
```

**等待编译完成！** 看到 "Compilation complete" 或类似信息。

---

### 2️⃣ 完全重启调试会话

1. **停止当前调试**：按 `Shift+F5` 或点击红色停止按钮
2. **等待 2 秒**
3. **重新启动**：按 `F5`

---

### 3️⃣ 打开开发者工具

在**扩展宿主窗口**（新打开的窗口）中：

- 按 `Ctrl+Shift+I` (Windows/Linux)
- 或 `Cmd+Option+I` (Mac)

---

### 4️⃣ 运行诊断命令

1. 按 `Ctrl+Shift+P` (或 `Cmd+Shift+P`)
2. 输入：`Diagnose Workflow`
3. 选择：`ScriptButler: Diagnose Workflow`
4. 查看控制台输出

---

## 📊 诊断命令输出解读

### 正常输出示例：

```
=== 工作流诊断信息 ===
工作流数量: 2
工作流列表: [
  {
    "id": "workflow-1234567890",
    "name": "测试工作流",
    "description": "...",
    "steps": [...]
  }
]
配置中的工作流: [同上]
```

**说明**：
- ✅ 工作流数量 > 0
- ✅ 工作流列表不为空
- ✅ 配置中的工作流与内存一致

---

### 异常输出 1：工作流数量为 0

```
=== 工作流诊断信息 ===
工作流数量: 0
工作流列表: []
配置中的工作流: []
```

**问题**：没有创建任何工作流，或创建失败

**解决方案**：
1. 尝试创建一个新工作流
2. 观察控制台是否有错误
3. 检查 `.vscode/settings.json` 文件权限

---

### 异常输出 2：内存与配置不一致

```
=== 工作流诊断信息 ===
工作流数量: 0
工作流列表: []
配置中的工作流: [
  { "id": "workflow-xxx", "name": "测试", ... }
]
```

**问题**：配置文件有数据，但内存中没有加载

**解决方案**：
1. 点击诊断对话框中的 **"重新加载"** 按钮
2. 或手动执行：`workflowTreeProvider.reload()`
3. 检查 `loadWorkflows()` 是否正确执行

---

## 🧪 测试步骤

### 步骤 1：创建测试工作流

1. 找到侧边栏的 **"工作流"** 视图
2. 点击 **"+"** 按钮
3. 输入名称：`测试工作流`
4. 选择创建方式并添加步骤
5. 确认创建

---

### 步骤 2：观察控制台日志

**应该看到以下日志**：

```
[WorkflowManager] 创建工作流: 测试工作流 (ID: workflow-xxxxxxxxxx)
[WorkflowManager] 当前工作流数量: 1
[WorkflowManager] 正在保存 1 个工作流: ["测试工作流"]
[WorkflowManager] 工作流已保存到配置
[WorkflowManager] 工作流 "测试工作流" 创建完成
[WorkflowTreeProvider] refresh() - 当前工作流数量: 1 ["测试工作流"]
[WorkflowTreeProvider] getChildren() 被调用, element: root
[WorkflowTreeProvider] getChildren() - 获取到 1 个工作流: [...]
[WorkflowTreeProvider] getChildren() - 过滤后有效工作流数量: 1
[WorkflowTreeProvider] getChildren() - 返回 1 个树项
```

---

### 步骤 3：检查 UI

**预期结果**：
- ✅ 新工作流立即显示在列表中
- ✅ 显示工作流名称和步骤数量
- ✅ 可以展开查看步骤

**如果没有显示**：
1. 运行诊断命令（见上文）
2. 点击 **"刷新视图"** 按钮
3. 查看控制台是否有错误

---

## 🔧 常见问题快速修复

### 问题 1：编译后代码没有更新

**症状**：修改了代码但日志没有变化

**快速修复**：
```bash
# 删除编译输出
rm -rf out/
# 或 Windows:
# rmdir /s /q out

# 重新编译
npm run compile

# 重启调试 (F5)
```

---

### 问题 2：getChildren() 没有被调用

**症状**：看到 refresh() 日志，但没有 getChildren() 日志

**快速修复**：
1. 手动折叠/展开工作流视图
2. 切换到其他视图再切换回来
3. 点击诊断命令中的 **"刷新视图"**

---

### 问题 3：工作流列表为空

**症状**：getChildren() 显示 "工作流列表为空"

**快速修复**：
1. 运行诊断命令
2. 如果配置中有数据，点击 **"重新加载"**
3. 如果配置中也没有数据，重新创建工作流

---

### 问题 4：配置文件没有更新

**症状**：创建工作流后 `.vscode/settings.json` 仍然为空

**快速修复**：
1. 检查文件权限
2. 检查控制台是否有保存错误
3. 尝试手动编辑配置文件测试写入权限

---

## 🎯 终极解决方案

如果以上所有方法都不行，尝试以下步骤：

### 方案 A：手动添加工作流

1. 打开 `.vscode/settings.json`
2. 添加以下内容：

```json
{
    "scriptButler.workflows": [
        {
            "id": "workflow-test-1",
            "name": "测试工作流",
            "description": "手动添加的测试工作流",
            "steps": [
                {
                    "type": "command",
                    "command": "echo 'Hello World'",
                    "mode": "serial",
                    "continueOnError": false
                }
            ]
        }
    ]
}
```

3. 保存文件
4. 观察控制台日志：

```
[ScriptButler] Workflow configuration changed, reloading...
[WorkflowTreeProvider] reload() - 从配置文件重新加载工作流
[WorkflowManager] 已加载 1 个工作流: ["测试工作流"]
```

5. 检查工作流是否显示

---

### 方案 B：使用 reload() 而不是 refresh()

如果 refresh() 不工作，临时改回使用 reload()：

在 `src/extension.ts` 中：

```typescript
// 创建工作流后
await workflowManager.createWorkflow(result.name, result.description, result.steps);
workflowTreeProvider.reload();  // 改用 reload()
```

**注意**：这可能导致竞态条件，但至少能让工作流显示出来。

---

### 方案 C：添加延迟

在保存和刷新之间添加短暂延迟：

```typescript
await workflowManager.createWorkflow(result.name, result.description, result.steps);
await new Promise(resolve => setTimeout(resolve, 200));  // 等待 200ms
workflowTreeProvider.refresh();
```

---

## 📝 收集诊断信息

如果问题仍然存在，请收集以下信息：

### 1. 控制台完整日志

从扩展启动到创建工作流的所有日志。

### 2. 诊断命令输出

运行 `ScriptButler: Diagnose Workflow` 的完整输出。

### 3. 配置文件内容

`.vscode/settings.json` 的完整内容。

### 4. 环境信息

- VS Code 版本
- 操作系统
- Node.js 版本

### 5. 错误信息

任何红色错误信息或警告。

---

## ✅ 验证修复成功

完成修复后，验证以下功能：

- [ ] 创建工作流后立即显示
- [ ] 编辑工作流后立即更新
- [ ] 删除工作流后立即移除
- [ ] 手动编辑配置文件后自动同步
- [ ] 重启 VS Code 后工作流仍然存在

---

## 🆘 需要帮助

如果完成所有步骤后问题仍然存在：

1. **运行诊断命令**并截图
2. **复制完整的控制台日志**
3. **提供配置文件内容**
4. **描述具体的操作步骤和现象**

这将帮助快速定位问题！

---

## 📞 快捷命令参考

| 命令 | 快捷键 | 说明 |
|------|--------|------|
| 打开命令面板 | `Ctrl+Shift+P` | 执行命令 |
| 打开开发者工具 | `Ctrl+Shift+I` | 查看日志 |
| 停止调试 | `Shift+F5` | 停止扩展 |
| 启动调试 | `F5` | 启动扩展 |
| 诊断工作流 | 命令面板搜索 | 检查状态 |

---

## 🎉 成功标志

当您看到以下情况时，说明问题已解决：

✅ 创建工作流后，**立即**在列表中看到新工作流  
✅ 控制台显示完整的日志链  
✅ 诊断命令显示正确的工作流数量  
✅ 配置文件包含工作流数据  
✅ 重启后工作流仍然存在  

恭喜！问题已完全修复！🎊

