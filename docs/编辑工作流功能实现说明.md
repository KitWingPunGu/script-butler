# 编辑工作流功能实现说明

## 🐛 问题描述

**错误信息：**
```
运行命令 scriptButler.editWorkflow 错误: command 'scriptButler.editWorkflow' not found。这可能是由提交 scriptButler.editWorkflow 的扩展引起的。
```

**触发场景：**
1. 打开"脚本管家"侧边栏
2. 展开"工作流"视图中的某个工作流
3. 右键点击工作流，选择"编辑工作流"
4. 或者点击工作流项上的编辑图标

**问题原因：**
- `scriptButler.editWorkflow` 命令在 `package.json` 中已声明
- 但在 `extension.ts` 中没有使用 `vscode.commands.registerCommand` 注册实现
- 导致命令无法执行

---

## ✅ 解决方案

### 实现 `scriptButler.editWorkflow` 命令

**文件：** `src/extension.ts`（第 263-325 行）

**实现内容：**

```typescript
// Edit workflow command
const editWorkflowCommand = vscode.commands.registerCommand(
    'scriptButler.editWorkflow',
    async (workflow: Workflow) => {
        // 1. 编辑工作流名称
        const newName = await vscode.window.showInputBox({
            prompt: '输入新的工作流名称',
            value: workflow.name,
            placeHolder: '例如：完整部署流程'
        });

        if (!newName) {
            return; // 用户取消
        }

        // 2. 编辑工作流描述
        const newDescription = await vscode.window.showInputBox({
            prompt: '输入新的工作流描述（可选）',
            value: workflow.description || '',
            placeHolder: '例如：清理、构建、测试、部署'
        });

        // 3. 询问是否编辑步骤
        const editSteps = await vscode.window.showQuickPick(
            [
                { label: '$(check) 保持步骤不变', value: false },
                { label: '$(edit) 重新创建步骤', value: true }
            ],
            {
                placeHolder: '是否重新创建工作流步骤？'
            }
        );

        if (!editSteps) {
            return; // 用户取消
        }

        let newSteps = workflow.steps;

        if (editSteps.value) {
            // 重新创建步骤
            const allScripts = scriptsTreeProvider.getAllScripts();
            const result = await workflowCreator.createWorkflow(allScripts);

            if (!result) {
                return; // 用户取消
            }

            newSteps = result.steps;
        }

        // 更新工作流
        await workflowManager.updateWorkflow(workflow.id, {
            name: newName,
            description: newDescription,
            steps: newSteps
        });

        workflowTreeProvider.refresh();
        vscode.window.showInformationMessage(`工作流 "${newName}" 已更新`);
    }
);
```

**注册到订阅列表：**

```typescript
context.subscriptions.push(
    // ... 其他命令
    createWorkflowCommand,
    runWorkflowCommand,
    editWorkflowCommand,      // ← 新增
    deleteWorkflowCommand,
    // ... 其他命令
);
```

---

## 🎯 功能特性

### 编辑工作流的三个步骤

#### **步骤 1：编辑工作流名称**

- 显示输入框，预填充当前名称
- 用户可以修改名称
- 必填项，取消则退出编辑

**示例：**
```
当前名称：前端部署流程
新名称：前后端联合部署
```

---

#### **步骤 2：编辑工作流描述**

- 显示输入框，预填充当前描述
- 用户可以修改描述
- 可选项，可以留空

**示例：**
```
当前描述：构建前端并部署
新描述：构建前端、测试后端、部署应用
```

---

#### **步骤 3：选择是否重新创建步骤**

用户可以选择：

1. **保持步骤不变**
   - 只修改名称和描述
   - 步骤保持原样
   - 适用于只需要修改元信息的情况

2. **重新创建步骤**
   - 打开工作流创建器
   - 用户可以选择创建模式（从列表选择 或 文本输入）
   - 完全替换原有步骤
   - 适用于需要修改步骤的情况

**选择界面：**
```
是否重新创建工作流步骤？

✓ 保持步骤不变
✎ 重新创建步骤
```

---

### 重新创建步骤的流程

如果用户选择"重新创建步骤"，会调用 `WorkflowCreator.createWorkflow()`：

1. **选择创建模式**
   - 从列表选择
   - 文本输入

2. **创建步骤**
   - 根据选择的模式创建步骤
   - 返回新的步骤列表

3. **更新工作流**
   - 使用新的步骤列表替换原有步骤
   - 保存到工作区设置

---

## 📊 使用示例

### 示例 1：只修改名称和描述

**原工作流：**
```json
{
  "id": "workflow-1234567890",
  "name": "部署流程",
  "description": "部署应用",
  "steps": [
    { "type": "script", "scriptName": "build", ... },
    { "type": "script", "scriptName": "deploy", ... }
  ]
}
```

**编辑步骤：**
1. 右键点击工作流，选择"编辑工作流"
2. 输入新名称："完整部署流程"
3. 输入新描述："构建、测试、部署"
4. 选择"保持步骤不变"

**更新后的工作流：**
```json
{
  "id": "workflow-1234567890",
  "name": "完整部署流程",
  "description": "构建、测试、部署",
  "steps": [
    { "type": "script", "scriptName": "build", ... },
    { "type": "script", "scriptName": "deploy", ... }
  ]
}
```

---

### 示例 2：修改名称并重新创建步骤

**原工作流：**
```json
{
  "id": "workflow-1234567890",
  "name": "前端部署",
  "description": "构建前端",
  "steps": [
    { "type": "script", "scriptName": "build", ... }
  ]
}
```

**编辑步骤：**
1. 右键点击工作流，选择"编辑工作流"
2. 输入新名称："前后端联合部署"
3. 输入新描述："构建前端、测试后端、部署应用"
4. 选择"重新创建步骤"
5. 选择创建模式："文本输入"
6. 输入命令序列：
   ```bash
   cd packages/frontend
   npm run build
   cd ../backend
   npm run test
   npm run deploy
   ```
7. 确认创建

**更新后的工作流：**
```json
{
  "id": "workflow-1234567890",
  "name": "前后端联合部署",
  "description": "构建前端、测试后端、部署应用",
  "steps": [
    { "type": "command", "command": "cd packages/frontend", ... },
    { "type": "command", "command": "npm run build", ... },
    { "type": "command", "command": "cd ../backend", ... },
    { "type": "command", "command": "npm run test", ... },
    { "type": "command", "command": "npm run deploy", ... }
  ]
}
```

---

## ✅ 验证步骤

### 1. 重新加载扩展

- 按 `F5` 启动调试
- 或执行 "Developer: Reload Window"

### 2. 创建测试工作流

1. 打开"工作流"视图
2. 点击 ➕ 按钮
3. 创建一个测试工作流

### 3. 测试编辑功能

#### **测试 1：只修改名称和描述**

1. 右键点击工作流
2. 选择"编辑工作流"
3. 修改名称和描述
4. 选择"保持步骤不变"
5. 验证工作流已更新

**预期结果：**
- ✅ 名称和描述已更新
- ✅ 步骤保持不变
- ✅ 显示提示："工作流 "XXX" 已更新"

#### **测试 2：重新创建步骤（从列表选择）**

1. 右键点击工作流
2. 选择"编辑工作流"
3. 修改名称
4. 选择"重新创建步骤"
5. 选择"从列表选择"
6. 选择几个脚本
7. 验证工作流已更新

**预期结果：**
- ✅ 名称已更新
- ✅ 步骤已替换为新选择的脚本
- ✅ 显示提示："工作流 "XXX" 已更新"

#### **测试 3：重新创建步骤（文本输入）**

1. 右键点击工作流
2. 选择"编辑工作流"
3. 修改名称
4. 选择"重新创建步骤"
5. 选择"文本输入"
6. 在编辑器中输入命令序列
7. 确认创建
8. 验证工作流已更新

**预期结果：**
- ✅ 名称已更新
- ✅ 步骤已替换为新输入的命令
- ✅ 显示提示："工作流 "XXX" 已更新"

### 4. 测试取消操作

1. 右键点击工作流
2. 选择"编辑工作流"
3. 在任意步骤点击"取消"或按 ESC
4. 验证工作流未被修改

**预期结果：**
- ✅ 工作流保持原样
- ✅ 不显示更新提示

### 5. 测试持久化

1. 编辑一个工作流
2. 关闭并重新打开 VS Code
3. 打开"工作流"视图
4. 验证修改是否保存

**预期结果：**
- ✅ 修改已保存
- ✅ 重启后仍然生效

---

## 🔍 相关代码

### `WorkflowManager.updateWorkflow()`

**文件：** `src/workflowManager.ts`（第 71-81 行）

```typescript
/**
 * 更新工作流
 */
async updateWorkflow(id: string, updates: Partial<Workflow>): Promise<boolean> {
    const workflow = this.workflows.find(wf => wf.id === id);
    
    if (workflow) {
        Object.assign(workflow, updates);
        await this.saveWorkflows();
        return true;
    }

    return false;
}
```

**功能：**
- ✅ 根据 ID 查找工作流
- ✅ 使用 `Object.assign()` 合并更新
- ✅ 保存到工作区设置
- ✅ 返回是否成功

---

## 🎉 总结

**问题：** 编辑工作流时报错"command 'scriptButler.editWorkflow' not found"

**原因：** 命令已声明但未注册实现

**解决方案：** 在 `extension.ts` 中实现并注册 `scriptButler.editWorkflow` 命令

**实现功能：**
- ✅ 编辑工作流名称
- ✅ 编辑工作流描述
- ✅ 选择是否重新创建步骤
- ✅ 保持步骤不变（只修改元信息）
- ✅ 重新创建步骤（完全替换）
- ✅ 支持两种创建模式（从列表选择 / 文本输入）
- ✅ 更新保存到工作区设置
- ✅ 刷新树视图显示
- ✅ 显示更新成功提示

**验证结果：**
- ✅ 编译成功
- ✅ 无诊断错误
- ✅ 命令正确注册

**现在可以正常编辑工作流了！** 🚀

