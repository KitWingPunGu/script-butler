# NPM 脚本管理器 - 功能更新说明

## 📅 更新日期
2025-01-04

## 🎯 本次更新内容

### ✅ 问题 1：多包管理器支持

#### **新增功能**

现在扩展支持自动检测并使用以下包管理器：

| 包管理器 | 检测方式 | 执行命令 |
|---------|---------|---------|
| **npm** | package-lock.json | `npm run <script>` |
| **pnpm** | pnpm-lock.yaml | `pnpm run <script>` |
| **Yarn Classic** | yarn.lock | `yarn <script>` |
| **Yarn Berry** | yarn.lock + .yarnrc.yml | `yarn run <script>` |

#### **实现细节**

1. **自动检测逻辑**
   - 优先级：pnpm > Yarn Berry > Yarn Classic > npm
   - 通过检测锁文件自动识别包管理器
   - Yarn Berry 通过 `.yarnrc.yml` 或 `.yarn/releases` 目录识别

2. **新增文件**
   - `src/packageManagerDetector.ts` - 包管理器检测器类
   - 包含缓存机制，避免重复检测

3. **用户配置**
   - 新增设置项：`npmScriptManager.packageManager`
   - 可选值：`auto`（默认）、`npm`、`pnpm`、`yarn`、`yarn-berry`
   - 手动配置会覆盖自动检测

4. **界面变化**
   - 终端名称从 `NPM: <script>` 改为 `<包管理器>: <script>`
   - 例如：`pnpm: dev`、`yarn: build`
   - 通知消息显示使用的包管理器：`正在运行 (pnpm): dev`

#### **使用示例**

**自动检测（推荐）：**
```json
// settings.json
{
  "npmScriptManager.packageManager": "auto"  // 默认值
}
```

**手动指定：**
```json
// settings.json
{
  "npmScriptManager.packageManager": "pnpm"
}
```

#### **测试方法**

1. 在 `test-workspace` 目录中已添加 `pnpm-lock.yaml`
2. 运行脚本时，终端名称会显示 `pnpm: <script>`
3. 执行的命令会是 `pnpm run <script>`

---

### ✅ 问题 2：收藏夹同步更新

#### **问题分析**

**原有行为：**
- 收藏夹使用 `${packageJsonPath}::${scriptName}` 作为唯一标识
- 当 package.json 中的脚本命令内容变化时，收藏夹能自动显示最新命令 ✅
- 但当脚本被删除时，收藏夹中不会有任何提示 ❌

**改进后的行为：**
- ✅ 脚本命令更新时，收藏夹自动同步显示最新命令
- ✅ 脚本被删除时，自动从收藏夹移除
- ✅ 刷新时显示移除的失效收藏数量

#### **实现细节**

1. **新增方法（favoritesManager.ts）**
   ```typescript
   // 清理失效的收藏
   async cleanupInvalidFavorites(allScripts: NpmScript[]): Promise<number>
   
   // 获取失效的收藏列表（用于显示）
   getInvalidFavorites(allScripts: NpmScript[]): string[]
   ```

2. **自动清理时机**
   - 手动刷新时（点击刷新按钮）
   - package.json 文件变化时（文件监视器触发）

3. **用户反馈**
   - 如果有失效收藏被移除，显示：`NPM 脚本已刷新，已移除 X 个失效的收藏`
   - 如果没有失效收藏，显示：`NPM 脚本已刷新`

#### **工作流程**

```
package.json 变化
    ↓
重新扫描脚本
    ↓
对比收藏夹中的脚本
    ↓
移除已删除的脚本
    ↓
刷新收藏夹视图
    ↓
显示清理结果
```

#### **测试场景**

**场景 1：脚本命令更新**
```json
// 修改前
"dev": "vite"

// 修改后
"dev": "webpack serve"
```
- 收藏夹中的 "dev" 脚本会自动显示新命令 `webpack serve`

**场景 2：脚本被删除**
```json
// 修改前
{
  "dev": "vite",
  "build": "tsc"
}

// 修改后（删除了 build）
{
  "dev": "vite"
}
```
- 如果 "build" 在收藏夹中，会被自动移除
- 显示提示：`NPM 脚本已刷新，已移除 1 个失效的收藏`

**场景 3：脚本重命名**
```json
// 修改前
"dev": "vite"

// 修改后
"start": "vite"
```
- 旧的 "dev" 会从收藏夹移除
- 需要重新收藏 "start"

---

### ✅ 问题 3：扩展名称评估

#### **"懒人命令助手" 评估结果**

**不推荐使用**，原因：
- ❌ 不够专业，影响企业用户信任度
- ❌ "懒人"略带贬义
- ❌ 未明确说明功能
- ❌ 搜索友好度低

#### **推荐的备选名称**

##### **🏆 首选：脚本管家 (Script Butler)**
**评分：4.75/5**

**优点：**
- ✅ 专业且亲切
- ✅ "管家"体现全方位管理
- ✅ 准确反映功能（管理+执行）
- ✅ 易于理解和记忆
- ✅ 适合企业和个人用户

**英文名：** Script Butler / Script Manager Pro

---

##### **🥈 次选：脚本快手 (Script Runner Pro)**
**评分：4.5/5**

**优点：**
- ✅ 简洁有力（3个字）
- ✅ "快手"传达速度和效率
- ✅ 专业且易记
- ✅ 准确描述核心功能

**缺点：**
- ⚠️ 可能与"快手"App有联想

**英文名：** Script Runner Pro / Quick Script Runner

---

##### **其他备选**

**3. 一键脚本 (One-Click Scripts)** - 评分：4.25/5
- 强调便捷性，但可能弱化管理功能

**4. 命令面板+ (Command Panel Plus)** - 评分：3.75/5
- 专业但可能与 VS Code 原生功能混淆

**5. 脚本工坊 (Script Workshop)** - 评分：3.5/5
- 独特但可能让人误以为是编辑器

#### **名称对比表**

| 名称 | 专业度 | 易记性 | 准确性 | 搜索友好 | 综合评分 |
|------|--------|--------|--------|----------|----------|
| 懒人命令助手 | ⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐ | 2.75/5 |
| **脚本管家** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | **4.75/5** |
| **脚本快手** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | **4.5/5** |
| 一键脚本 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 4.25/5 |

---

## 📋 修改的文件清单

### 新增文件
1. `src/packageManagerDetector.ts` - 包管理器检测器
2. `test-workspace/pnpm-lock.yaml` - 测试文件
3. `更新说明.md` - 本文档

### 修改的文件
1. `package.json` - 添加配置项
2. `src/scriptExecutor.ts` - 集成包管理器检测
3. `src/favoritesManager.ts` - 添加失效收藏清理
4. `src/extension.ts` - 集成自动清理逻辑

---

## 🧪 测试指南

### 测试包管理器检测

1. **测试 pnpm 检测**
   ```bash
   # test-workspace 目录已有 pnpm-lock.yaml
   # 运行任意脚本，终端名称应显示 "pnpm: <script>"
   ```

2. **测试手动配置**
   ```json
   // settings.json
   {
     "npmScriptManager.packageManager": "yarn"
   }
   ```
   - 运行脚本，应使用 `yarn <script>` 命令

3. **测试自动检测**
   - 删除 `pnpm-lock.yaml`
   - 应自动回退到 npm（因为有 package-lock.json）

### 测试收藏夹同步

1. **测试命令更新**
   - 收藏一个脚本（如 "dev"）
   - 修改 package.json 中的命令内容
   - 保存后，收藏夹应自动显示新命令

2. **测试脚本删除**
   - 收藏一个脚本
   - 从 package.json 中删除该脚本
   - 点击刷新，应显示 "已移除 1 个失效的收藏"

3. **测试自动清理**
   - 收藏多个脚本
   - 删除其中几个
   - 保存 package.json（触发文件监视器）
   - 收藏夹应自动更新

---

## 🚀 使用建议

### 包管理器配置

**推荐使用自动检测（默认）：**
- 适合大多数场景
- 自动适应项目配置
- 无需手动维护

**手动配置适用于：**
- 项目中有多个锁文件
- 需要强制使用特定包管理器
- 团队统一规范

### 收藏夹管理

**最佳实践：**
- 定期检查收藏夹，移除不常用的脚本
- 脚本重命名后记得重新收藏
- 利用自动清理功能保持收藏夹整洁

---

## 📊 性能优化

1. **包管理器检测缓存**
   - 每个目录只检测一次
   - 缓存结果直到扩展重启

2. **失效收藏清理**
   - 仅在刷新时执行
   - 不影响日常使用性能

---

## 🎉 总结

本次更新解决了三个重要问题：

1. ✅ **多包管理器支持** - 自动检测 npm/pnpm/yarn，提升兼容性
2. ✅ **收藏夹同步** - 自动清理失效收藏，保持数据一致性
3. ✅ **名称建议** - 提供专业的扩展命名方案

**下一步建议：**
- 测试所有新功能
- 根据需要选择合适的扩展名称
- 考虑发布到 VS Code 市场

---

**需要帮助？** 查看 README_CN.md 或 TROUBLESHOOTING.md

