# 🔧 工作流不显示问题诊断指南

## ⚠️ 重要提示

**您必须先重新编译和重启扩展，修改才会生效！**

---

## 📋 诊断步骤

### 第 1 步：重新编译扩展

在终端中运行：

```bash
npm run compile
```

或者：

```bash
npm run watch
```

**等待编译完成**，确保没有错误。

---

### 第 2 步：重启调试会话

1. **停止当前调试**：
   - 点击调试工具栏的停止按钮 (红色方块)
   - 或按 `Shift+F5`

2. **重新启动调试**：
   - 按 `F5` 启动新的调试会话
   - 等待扩展宿主窗口打开

---

### 第 3 步：打开开发者工具

在**扩展宿主窗口**（不是主窗口）中：

- **Windows/Linux**: 按 `Ctrl+Shift+I`
- **Mac**: 按 `Cmd+Option+I`
- 切换到 **Console** 标签

---

### 第 4 步：检查初始化日志

在控制台中查找以下日志：

```
[WorkflowManager] 已加载 X 个工作流: [...]
```

**如果看到这条日志**：
- ✅ WorkflowManager 初始化成功
- 记录显示的工作流数量

**如果没有看到**：
- ❌ 扩展可能没有正确加载
- 检查是否有错误信息

---

### 第 5 步：创建测试工作流

1. **找到工作流视图**：
   - 在侧边栏找到 "工作流" 视图
   - 如果看不到，检查视图是否被折叠

2. **点击 "+" 按钮**创建工作流

3. **观察控制台日志**，应该看到：

```
[WorkflowManager] 创建工作流: 测试工作流 (ID: workflow-xxxxxxxxxx)
[WorkflowManager] 当前工作流数量: 1
[WorkflowManager] 正在保存 1 个工作流: ["测试工作流"]
[WorkflowManager] 工作流已保存到配置
[WorkflowManager] 工作流 "测试工作流" 创建完成
[WorkflowTreeProvider] refresh() - 当前工作流数量: 1 ["测试工作流"]
[WorkflowTreeProvider] getChildren() 被调用, element: root
[WorkflowTreeProvider] getChildren() - 获取到 1 个工作流: [...]
[WorkflowTreeProvider] getChildren() - 过滤后有效工作流数量: 1
[WorkflowTreeProvider] getChildren() - 返回 1 个树项
```

---

### 第 6 步：分析日志

#### 情况 A：看到完整的日志链

✅ **说明**：代码执行正常

**检查点**：
1. `getChildren()` 是否被调用？
2. 返回的树项数量是否正确？
3. UI 是否更新？

**如果 UI 没有更新**：
- 可能是 VS Code 的 TreeView 缓存问题
- 尝试手动刷新视图
- 尝试折叠/展开视图

---

#### 情况 B：日志在某个步骤中断

❌ **说明**：代码执行出错

**检查点**：
1. 在哪个步骤中断？
2. 是否有错误信息？
3. 控制台是否显示红色错误？

**常见问题**：
- `createWorkflow()` 没有被调用 → 检查命令注册
- `saveWorkflows()` 失败 → 检查配置权限
- `refresh()` 没有触发 → 检查事件发射器

---

#### 情况 C：完全没有日志

❌ **说明**：扩展没有正确加载或编译

**解决方法**：
1. 确认编译成功（检查 `out/` 目录）
2. 确认调试会话已重启
3. 检查扩展是否激活（查看扩展列表）
4. 查看 VS Code 的输出面板是否有错误

---

### 第 7 步：检查配置文件

打开 `.vscode/settings.json`：

```json
{
    "scriptButler.workflows": [
        {
            "id": "workflow-xxxxxxxxxx",
            "name": "测试工作流",
            "description": "...",
            "steps": [...]
        }
    ]
}
```

**检查点**：
- ✅ 配置文件是否包含新创建的工作流？
- ✅ 工作流数据格式是否正确？
- ✅ `id`、`name`、`steps` 字段是否存在？

**如果配置文件为空或没有更新**：
- ❌ `saveWorkflows()` 可能失败
- 检查控制台是否有保存错误
- 检查文件权限

---

### 第 8 步：手动测试 reload()

在控制台中手动执行：

```javascript
// 注意：这需要在扩展宿主窗口的控制台中执行
// 但通常无法直接访问扩展实例

// 替代方法：在代码中添加测试命令
```

**更好的方法**：手动编辑配置文件触发 reload

1. 打开 `.vscode/settings.json`
2. 手动添加一个工作流：

```json
{
    "scriptButler.workflows": [
        {
            "id": "workflow-test-manual",
            "name": "手动测试工作流",
            "description": "测试 reload 功能",
            "steps": [
                {
                    "type": "command",
                    "command": "echo 'test'",
                    "mode": "serial",
                    "continueOnError": false
                }
            ]
        }
    ]
}
```

3. 保存文件
4. **观察控制台日志**：

```
[ScriptButler] Workflow configuration changed, reloading...
[WorkflowTreeProvider] reload() - 从配置文件重新加载工作流
[WorkflowManager] 已加载 1 个工作流: ["手动测试工作流"]
[WorkflowTreeProvider] reload() - 重新加载后工作流数量: 1 ["手动测试工作流"]
[WorkflowTreeProvider] getChildren() 被调用, element: root
[WorkflowTreeProvider] getChildren() - 获取到 1 个工作流: [...]
```

5. **检查 UI**：工作流是否显示？

---

## 🐛 常见问题和解决方案

### 问题 1：编译后仍然使用旧代码

**症状**：
- 修改了代码但日志没有变化
- 新添加的 console.log 没有输出

**解决方案**：
1. 完全停止调试会话
2. 删除 `out/` 目录
3. 重新运行 `npm run compile`
4. 重新启动调试 (F5)

---

### 问题 2：getChildren() 没有被调用

**症状**：
- 看到 `refresh()` 日志
- 但没有看到 `getChildren()` 日志

**可能原因**：
- TreeView 没有正确注册
- `_onDidChangeTreeData.fire()` 没有触发
- VS Code 认为数据没有变化

**解决方案**：
1. 检查 `extension.ts` 中的视图注册
2. 确认 `workflowTreeProvider` 正确传递给 `createTreeView`
3. 尝试手动展开/折叠视图

---

### 问题 3：getChildren() 返回空数组

**症状**：
- `getChildren()` 被调用
- 但日志显示 "工作流列表为空"

**可能原因**：
- `workflowManager.getAllWorkflows()` 返回空数组
- 内存数据没有正确更新
- 配置保存失败

**解决方案**：
1. 检查 `createWorkflow()` 是否成功
2. 检查 `this.workflows.push(workflow)` 是否执行
3. 检查 `getAllWorkflows()` 的实现

---

### 问题 4：工作流被过滤掉

**症状**：
- `getChildren()` 获取到工作流
- 但 "过滤后有效工作流数量" 为 0

**可能原因**：
- 工作流对象格式不正确
- `wf.name` 为 undefined 或空字符串

**解决方案**：
1. 检查创建的工作流对象
2. 确认 `name` 字段存在且不为空
3. 打印完整的工作流对象查看结构

---

### 问题 5：TreeView 缓存问题

**症状**：
- 所有日志都正常
- `getChildren()` 返回正确的树项
- 但 UI 不更新

**可能原因**：
- VS Code 的 TreeView 缓存
- 视图没有正确刷新

**解决方案**：
1. 手动折叠/展开视图
2. 切换到其他视图再切换回来
3. 重启扩展宿主窗口
4. 检查 `_onDidChangeTreeData` 是否正确初始化

---

## 📊 诊断检查清单

完成以下检查，找出问题所在：

- [ ] 代码已重新编译（`npm run compile`）
- [ ] 调试会话已重启（停止后重新按 F5）
- [ ] 开发者工具已打开（Ctrl+Shift+I）
- [ ] 看到 WorkflowManager 初始化日志
- [ ] 创建工作流时看到完整日志链
- [ ] `getChildren()` 被调用
- [ ] `getChildren()` 返回的树项数量正确
- [ ] 配置文件包含新创建的工作流
- [ ] 工作流数据格式正确
- [ ] 手动编辑配置文件能触发 reload
- [ ] 没有红色错误信息

---

## 🎯 下一步

根据诊断结果：

### 如果所有日志都正常但 UI 不更新

→ 这是 TreeView 刷新问题，需要检查事件发射器

### 如果 getChildren() 没有被调用

→ 这是视图注册或事件触发问题

### 如果 getChildren() 返回空数组

→ 这是数据管理问题，检查 WorkflowManager

### 如果配置文件没有更新

→ 这是配置保存问题，检查权限和错误处理

---

## 💡 临时解决方案

如果问题仍然无法解决，可以尝试：

1. **手动刷新命令**：
   - 添加一个手动刷新工作流列表的命令
   - 绑定到按钮或快捷键

2. **使用 reload() 而不是 refresh()**：
   - 虽然可能有竞态条件
   - 但至少能确保数据同步

3. **添加延迟**：
   ```typescript
   await workflowManager.createWorkflow(...);
   await new Promise(resolve => setTimeout(resolve, 100));
   workflowTreeProvider.refresh();
   ```

---

## 📞 需要帮助？

如果完成所有诊断步骤后问题仍然存在，请提供：

1. **完整的控制台日志**（从启动到创建工作流）
2. **配置文件内容**（`.vscode/settings.json`）
3. **VS Code 版本**
4. **操作系统**
5. **具体的错误信息**（如果有）

这将帮助我们更快地定位问题！

