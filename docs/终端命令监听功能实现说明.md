# ç»ˆç«¯å‘½ä»¤ç›‘å¬åŠŸèƒ½å®ç°è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ç»ˆç«¯å‘½ä»¤ç›‘å¬åŠŸèƒ½æ˜¯"è„šæœ¬ç®¡å®¶"æ‰©å±•çš„ä¸€ä¸ª**å®éªŒæ€§åŠŸèƒ½**ï¼Œå¯ä»¥è‡ªåŠ¨æ•è·å¹¶è®°å½•ç”¨æˆ·åœ¨ VS Code é›†æˆç»ˆç«¯ä¸­æ‰‹åŠ¨æ‰§è¡Œçš„ npm/pnpm/yarn è„šæœ¬å‘½ä»¤åˆ°"æœ€è¿‘æ‰§è¡Œ"å†å²ä¸­ã€‚

**æ ¸å¿ƒç‰¹æ€§ï¼š**
- âœ… è‡ªåŠ¨ç›‘å¬ç»ˆç«¯ä¸­çš„å‘½ä»¤æ‰§è¡Œ
- âœ… è¯†åˆ« npm/pnpm/yarn è„šæœ¬å‘½ä»¤
- âœ… è‡ªåŠ¨è®°å½•åˆ°"æœ€è¿‘æ‰§è¡Œ"å†å²
- âœ… å®æ—¶æ˜¾ç¤ºç›‘å¬çŠ¶æ€
- âœ… å¯é€‰å¯ç”¨/ç¦ç”¨

---

## ğŸ¯ å®ç°æ–¹æ¡ˆ

### æŠ€æœ¯é€‰å‹

ä½¿ç”¨ **VS Code Shell Integration API**ï¼Œè¿™æ˜¯å®˜æ–¹æ¨èçš„ç»ˆç«¯å‘½ä»¤ç›‘å¬æ–¹æ¡ˆã€‚

**å…³é”® APIï¼š**
- `window.onDidChangeTerminalShellIntegration` - ç›‘å¬ Shell Integration æ¿€æ´»
- `window.onDidStartTerminalShellExecution` - ç›‘å¬å‘½ä»¤å¼€å§‹æ‰§è¡Œ
- `window.onDidEndTerminalShellExecution` - ç›‘å¬å‘½ä»¤æ‰§è¡Œç»“æŸ

**ä¼˜åŠ¿ï¼š**
- å®˜æ–¹æ”¯æŒï¼Œç¨³å®šå¯é 
- å¯ä»¥è·å–å®Œæ•´çš„å‘½ä»¤è¡Œæ–‡æœ¬
- å¯ä»¥è·å–å‘½ä»¤çš„é€€å‡ºç 
- æ€§èƒ½å¥½ï¼Œå‡†ç¡®æ€§é«˜

**é™åˆ¶ï¼š**
- éœ€è¦ Shell Integration æ”¯æŒ
- ä»…æ”¯æŒ bash/zsh/fish/pwsh
- ä¸æ”¯æŒ cmd.exe

---

## ğŸ“ æ–‡ä»¶ç»“æ„

### æ–°å¢æ–‡ä»¶

#### 1. `src/terminalMonitor.ts`

**æ ¸å¿ƒç›‘å¬æ¨¡å—**ï¼Œè´Ÿè´£ï¼š
- ç›‘å¬ç»ˆç«¯ Shell Integration æ¿€æ´»
- ç›‘å¬å‘½ä»¤æ‰§è¡Œå¼€å§‹å’Œç»“æŸ
- è§£æå‘½ä»¤è¡Œï¼Œè¯†åˆ«è„šæœ¬å‘½ä»¤
- è®°å½•åˆ°å†å²ç®¡ç†å™¨
- ç»´æŠ¤ç›‘å¬ç»Ÿè®¡ä¿¡æ¯

**å…³é”®ç±»ï¼š**

```typescript
export class TerminalMonitor {
    constructor(
        private historyManager: HistoryManager,
        private packageScanner: PackageScanner
    )
    
    // è·å–ç›‘å¬ç»Ÿè®¡ä¿¡æ¯
    getStats(): TerminalMonitorStats
    
    // è·å–çŠ¶æ€æè¿°
    getStatusDescription(): string
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æ”¯æŒçš„ç»ˆç«¯
    hasIntegratedTerminals(): boolean
    
    // ç»Ÿè®¡ä¿¡æ¯å˜åŒ–äº‹ä»¶
    onStatsChange: Event<TerminalMonitorStats>
}
```

**ç»Ÿè®¡ä¿¡æ¯æ¥å£ï¼š**

```typescript
export interface TerminalMonitorStats {
    totalTerminals: number;        // æ€»ç»ˆç«¯æ•°
    integratedTerminals: number;   // æ”¯æŒ Shell Integration çš„ç»ˆç«¯æ•°
    commandsCaptured: number;      // å·²æ•è·çš„å‘½ä»¤æ•°
}
```

**å‘½ä»¤åŒ¹é…é€»è¾‘ï¼š**

```typescript
// æ”¯æŒçš„å‘½ä»¤æ¨¡å¼
const patterns = [
    { regex: /^npm\s+run\s+([^\s]+)/, manager: 'npm' },
    { regex: /^pnpm\s+(?:run\s+)?([^\s]+)/, manager: 'pnpm' },
    { regex: /^yarn\s+(?:run\s+)?([^\s]+)/, manager: 'yarn' }
];

// è·³è¿‡éè„šæœ¬å‘½ä»¤
const nonScriptCommands = ['install', 'add', 'remove', 'update', 'init', 'create'];
```

---

### ä¿®æ”¹çš„æ–‡ä»¶

#### 2. `src/historyTreeProvider.ts`

**æ·»åŠ ç»ˆç«¯ç›‘å¬çŠ¶æ€æ˜¾ç¤º**

**æ–°å¢ç±»ï¼š**

```typescript
class TerminalMonitorStatusItem extends vscode.TreeItem {
    constructor(terminalMonitor: TerminalMonitor | undefined)
}
```

**çŠ¶æ€æ˜¾ç¤ºé€»è¾‘ï¼š**
- å¦‚æœå¯ç”¨ï¼šæ˜¾ç¤º "ç»ˆç«¯ç›‘å¬" + ç»Ÿè®¡ä¿¡æ¯
- å¦‚æœç¦ç”¨ï¼šæ˜¾ç¤º "ç»ˆç«¯ç›‘å¬ï¼ˆå·²ç¦ç”¨ï¼‰" + ç‚¹å‡»å¯ç”¨æç¤º

**å›¾æ ‡é€»è¾‘ï¼š**
- âœ… æœ‰æ”¯æŒçš„ç»ˆç«¯ï¼šç»¿è‰²çœ¼ç›å›¾æ ‡ (`eye`)
- â³ ç­‰å¾…æ¿€æ´»ï¼šé»„è‰²é—­çœ¼å›¾æ ‡ (`eye-closed`)
- âŒ å·²ç¦ç”¨ï¼šç°è‰²é—­çœ¼å›¾æ ‡ (`eye-closed`)

**ä¿®æ”¹çš„æ–¹æ³•ï¼š**

```typescript
export class HistoryTreeProvider {
    // æ–°å¢æ–¹æ³•ï¼šè®¾ç½® TerminalMonitor å®ä¾‹
    setTerminalMonitor(terminalMonitor: TerminalMonitor | undefined): void
    
    // ä¿®æ”¹è¿”å›ç±»å‹ï¼ŒåŒ…å«çŠ¶æ€é¡¹
    async getChildren(): Promise<(HistoryTreeItem | TerminalMonitorStatusItem)[]>
}
```

#### 3. `src/extension.ts`

**é›†æˆ TerminalMonitor**

**å¯¼å…¥ï¼š**

```typescript
import { TerminalMonitor } from './terminalMonitor';
```

**åˆå§‹åŒ–é€»è¾‘ï¼š**

```typescript
// è¯»å–é…ç½®
const enableTerminalMonitoring = vscode.workspace
    .getConfiguration('scriptButler')
    .get<boolean>('enableTerminalMonitoring', false);

// æ ¹æ®é…ç½®å¯ç”¨/ç¦ç”¨
if (enableTerminalMonitoring) {
    terminalMonitor = new TerminalMonitor(historyManager, packageScanner);
    context.subscriptions.push(terminalMonitor);
    
    // ä¼ é€’ç»™ historyTreeProvider
    historyTreeProvider.setTerminalMonitor(terminalMonitor);
    
    // ç›‘å¬ç»Ÿè®¡ä¿¡æ¯å˜åŒ–ï¼Œåˆ·æ–°å†å²è§†å›¾
    terminalMonitor.onStatsChange(() => {
        historyTreeProvider.refresh();
    });
}
```

**æ–°å¢å‘½ä»¤ï¼š**

```typescript
// åˆ‡æ¢ç»ˆç«¯ç›‘å¬åŠŸèƒ½
const toggleTerminalMonitoringCommand = vscode.commands.registerCommand(
    'scriptButler.toggleTerminalMonitoring',
    async () => {
        // åˆ‡æ¢é…ç½®
        // æç¤ºé‡æ–°åŠ è½½çª—å£
    }
);
```

#### 4. `package.json`

**æ–°å¢é…ç½®é¡¹ï¼š**

```json
{
  "configuration": {
    "properties": {
      "scriptButler.enableTerminalMonitoring": {
        "type": "boolean",
        "default": false,
        "description": "å¯ç”¨ç»ˆç«¯å‘½ä»¤ç›‘å¬åŠŸèƒ½ï¼ˆå®éªŒæ€§ï¼‰ã€‚è‡ªåŠ¨æ•è·å¹¶è®°å½•ç»ˆç«¯ä¸­æ‰§è¡Œçš„ npm/pnpm/yarn è„šæœ¬å‘½ä»¤åˆ°ã€æœ€è¿‘æ‰§è¡Œã€‘å†å²ã€‚éœ€è¦ Shell Integration æ”¯æŒï¼Œä»…é€‚ç”¨äº bash/zsh/fish/pwshã€‚"
      },
      "scriptButler.terminalMonitoring.showNotifications": {
        "type": "boolean",
        "default": false,
        "description": "å½“ç»ˆç«¯ç›‘å¬æ•è·åˆ°è„šæœ¬æ‰§è¡Œæ—¶æ˜¾ç¤ºé€šçŸ¥"
      }
    }
  }
}
```

---

## ğŸ”§ å·¥ä½œæµç¨‹

### 1. åˆå§‹åŒ–æµç¨‹

```mermaid
graph TD
    A[æ‰©å±•æ¿€æ´»] --> B{è¯»å–é…ç½®}
    B -->|å¯ç”¨| C[åˆ›å»º TerminalMonitor]
    B -->|ç¦ç”¨| D[è·³è¿‡åˆå§‹åŒ–]
    C --> E[æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨]
    E --> F[ä¼ é€’ç»™ HistoryTreeProvider]
    F --> G[æ˜¾ç¤ºå¯ç”¨é€šçŸ¥]
```

### 2. å‘½ä»¤æ•è·æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·åœ¨ç»ˆç«¯è¾“å…¥å‘½ä»¤] --> B[Shell Integration æ•è·]
    B --> C[è§¦å‘ onDidEndTerminalShellExecution]
    C --> D{æ£€æŸ¥ç½®ä¿¡åº¦}
    D -->|High| E[è§£æå‘½ä»¤è¡Œ]
    D -->|Low| F[è·³è¿‡]
    E --> G{åŒ¹é…è„šæœ¬å‘½ä»¤?}
    G -->|æ˜¯| H[æŸ¥æ‰¾å¯¹åº”çš„ NpmScript]
    G -->|å¦| I[è·³è¿‡]
    H --> J{æ‰¾åˆ°è„šæœ¬?}
    J -->|æ˜¯| K[è®°å½•åˆ°å†å²]
    J -->|å¦| L[è·³è¿‡]
    K --> M[æ›´æ–°ç»Ÿè®¡ä¿¡æ¯]
    M --> N[åˆ·æ–°å†å²è§†å›¾]
```

### 3. çŠ¶æ€æ˜¾ç¤ºæµç¨‹

```mermaid
graph TD
    A[HistoryTreeProvider.getChildren] --> B[åˆ›å»ºçŠ¶æ€é¡¹]
    B --> C{TerminalMonitor å­˜åœ¨?}
    C -->|æ˜¯| D[è·å–ç»Ÿè®¡ä¿¡æ¯]
    C -->|å¦| E[æ˜¾ç¤ºç¦ç”¨çŠ¶æ€]
    D --> F{æœ‰æ”¯æŒçš„ç»ˆç«¯?}
    F -->|æ˜¯| G[æ˜¾ç¤ºç»¿è‰²çœ¼ç›å›¾æ ‡]
    F -->|å¦| H[æ˜¾ç¤ºé»„è‰²é—­çœ¼å›¾æ ‡]
    E --> I[æ˜¾ç¤ºç°è‰²é—­çœ¼å›¾æ ‡]
    I --> J[æ·»åŠ ç‚¹å‡»å¯ç”¨å‘½ä»¤]
```

---

## ğŸ“Š å‘½ä»¤åŒ¹é…è§„åˆ™

### æ”¯æŒçš„å‘½ä»¤æ ¼å¼

| åŒ…ç®¡ç†å™¨ | å‘½ä»¤æ ¼å¼ | ç¤ºä¾‹ |
|---------|---------|------|
| npm | `npm run <script>` | `npm run dev` |
| pnpm | `pnpm <script>` | `pnpm dev` |
| pnpm | `pnpm run <script>` | `pnpm run dev` |
| yarn | `yarn <script>` | `yarn dev` |
| yarn | `yarn run <script>` | `yarn run dev` |

### æ’é™¤çš„å‘½ä»¤

ä»¥ä¸‹å‘½ä»¤ä¸ä¼šè¢«è¯†åˆ«ä¸ºè„šæœ¬å‘½ä»¤ï¼š
- `install` / `add` / `remove` / `update`
- `init` / `create`

### åŒ¹é…æµç¨‹

1. **æ­£åˆ™åŒ¹é…**ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–è„šæœ¬åç§°
2. **æ’é™¤æ£€æŸ¥**ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºéè„šæœ¬å‘½ä»¤
3. **è„šæœ¬æŸ¥æ‰¾**ï¼šåœ¨ package.json ä¸­æŸ¥æ‰¾å¯¹åº”çš„è„šæœ¬
4. **è®°å½•å†å²**ï¼šå¦‚æœæ‰¾åˆ°ï¼Œè®°å½•åˆ°å†å²ç®¡ç†å™¨

---

## ğŸ¨ UI è®¾è®¡

### å†å²è§†å›¾ä¸­çš„çŠ¶æ€é¡¹

**å¯ç”¨ä¸”æœ‰æ”¯æŒçš„ç»ˆç«¯ï¼š**
```
ğŸ‘ï¸ ç»ˆç«¯ç›‘å¬                    2/3 ç»ˆç«¯
```

**å¯ç”¨ä½†ç­‰å¾…æ¿€æ´»ï¼š**
```
ğŸ‘ï¸â€ğŸ—¨ï¸ ç»ˆç«¯ç›‘å¬                    0/1 ç»ˆç«¯
```

**ç¦ç”¨çŠ¶æ€ï¼š**
```
ğŸ‘ï¸â€ğŸ—¨ï¸ ç»ˆç«¯ç›‘å¬ï¼ˆå·²ç¦ç”¨ï¼‰          ç‚¹å‡»å¯ç”¨
```

### Tooltip ä¿¡æ¯

**å¯ç”¨çŠ¶æ€ï¼š**
```
ç»ˆç«¯ç›‘å¬: âœ… å·²å¯ç”¨ (2/3 ç»ˆç«¯æ”¯æŒ)

æ€»ç»ˆç«¯æ•°: 3
æ”¯æŒç›‘å¬: 2
å·²æ•è·å‘½ä»¤: 15
```

**ç¦ç”¨çŠ¶æ€ï¼š**
```
ç»ˆç«¯ç›‘å¬åŠŸèƒ½å·²ç¦ç”¨

ç‚¹å‡»ä»¥å¯ç”¨ç»ˆç«¯å‘½ä»¤ç›‘å¬åŠŸèƒ½
```

---

## âš™ï¸ é…ç½®è¯´æ˜

### `scriptButler.enableTerminalMonitoring`

- **ç±»å‹**ï¼š`boolean`
- **é»˜è®¤å€¼**ï¼š`false`
- **è¯´æ˜**ï¼šå¯ç”¨ç»ˆç«¯å‘½ä»¤ç›‘å¬åŠŸèƒ½ï¼ˆå®éªŒæ€§ï¼‰

**å¯ç”¨æ–¹æ³•ï¼š**

1. **é€šè¿‡è®¾ç½®ç•Œé¢**ï¼š
   - æ‰“å¼€è®¾ç½®ï¼ˆ`Ctrl+,`ï¼‰
   - æœç´¢ "scriptButler"
   - å‹¾é€‰ "Enable Terminal Monitoring"

2. **é€šè¿‡å‘½ä»¤**ï¼š
   - æ‰“å¼€å‘½ä»¤é¢æ¿ï¼ˆ`Ctrl+Shift+P`ï¼‰
   - æœç´¢å¹¶æ‰§è¡Œ "è„šæœ¬ç®¡å®¶: åˆ‡æ¢ç»ˆç«¯ç›‘å¬åŠŸèƒ½"
   - ç‚¹å‡»"é‡æ–°åŠ è½½"æŒ‰é’®

3. **é€šè¿‡ settings.json**ï¼š
   ```json
   {
     "scriptButler.enableTerminalMonitoring": true
   }
   ```

### `scriptButler.terminalMonitoring.showNotifications`

- **ç±»å‹**ï¼š`boolean`
- **é»˜è®¤å€¼**ï¼š`false`
- **è¯´æ˜**ï¼šå½“ç»ˆç«¯ç›‘å¬æ•è·åˆ°è„šæœ¬æ‰§è¡Œæ—¶æ˜¾ç¤ºé€šçŸ¥

**æ•ˆæœï¼š**
- å¯ç”¨åï¼Œæ¯æ¬¡æ•è·åˆ°è„šæœ¬å‘½ä»¤éƒ½ä¼šæ˜¾ç¤ºé€šçŸ¥
- é€šçŸ¥å†…å®¹ï¼š`å·²è®°å½•è„šæœ¬æ‰§è¡Œ: <script-name>`

---

## ğŸ§ª æµ‹è¯•æŒ‡å—

### æµ‹è¯•æ­¥éª¤

1. **å¯ç”¨åŠŸèƒ½**
   ```
   è®¾ç½® -> scriptButler.enableTerminalMonitoring = true
   é‡æ–°åŠ è½½çª—å£
   ```

2. **æ‰“å¼€ç»ˆç«¯**
   ```
   Ctrl+` æ‰“å¼€é›†æˆç»ˆç«¯
   ```

3. **ç­‰å¾… Shell Integration æ¿€æ´»**
   ```
   æŸ¥çœ‹"æœ€è¿‘æ‰§è¡Œ"è§†å›¾ä¸­çš„çŠ¶æ€é¡¹
   åº”è¯¥æ˜¾ç¤º "ç»ˆç«¯ç›‘å¬: â³ ç­‰å¾… Shell Integration æ¿€æ´»"
   ```

4. **æ‰§è¡Œè„šæœ¬å‘½ä»¤**
   ```bash
   npm run dev
   # æˆ–
   pnpm dev
   # æˆ–
   yarn dev
   ```

5. **éªŒè¯è®°å½•**
   ```
   æ£€æŸ¥"æœ€è¿‘æ‰§è¡Œ"è§†å›¾
   åº”è¯¥çœ‹åˆ°åˆšæ‰§è¡Œçš„è„šæœ¬å‡ºç°åœ¨å†å²ä¸­
   ```

6. **æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯**
   ```
   æŸ¥çœ‹çŠ¶æ€é¡¹çš„ tooltip
   "å·²æ•è·å‘½ä»¤" æ•°é‡åº”è¯¥å¢åŠ 
   ```

### æµ‹è¯•ç”¨ä¾‹

| æµ‹è¯•ç”¨ä¾‹ | å‘½ä»¤ | é¢„æœŸç»“æœ |
|---------|------|---------|
| npm è„šæœ¬ | `npm run dev` | âœ… è®°å½•åˆ°å†å² |
| pnpm è„šæœ¬ | `pnpm dev` | âœ… è®°å½•åˆ°å†å² |
| yarn è„šæœ¬ | `yarn dev` | âœ… è®°å½•åˆ°å†å² |
| npm install | `npm install` | âŒ ä¸è®°å½• |
| ä¸å­˜åœ¨çš„è„šæœ¬ | `npm run nonexistent` | âŒ ä¸è®°å½• |
| Git å‘½ä»¤ | `git status` | âŒ ä¸è®°å½•ï¼ˆæœªå®ç°ï¼‰|

---

## ğŸ› å·²çŸ¥é™åˆ¶

1. **Shell å…¼å®¹æ€§**
   - âœ… æ”¯æŒï¼šbash, zsh, fish, pwsh
   - âŒ ä¸æ”¯æŒï¼šcmd.exe

2. **æ¿€æ´»æ—¶æœº**
   - Shell Integration ä¸æ˜¯ç«‹å³æ¿€æ´»çš„
   - å¯èƒ½éœ€è¦ç­‰å¾…å‡ ç§’
   - æŸäº›ç»ˆç«¯å¯èƒ½æ°¸è¿œä¸ä¼šæ¿€æ´»

3. **å‘½ä»¤è¯†åˆ«**
   - åªè¯†åˆ« npm/pnpm/yarn è„šæœ¬å‘½ä»¤
   - ä¸è¯†åˆ« Git å‘½ä»¤ï¼ˆå¯æ‰©å±•ï¼‰
   - ä¸è¯†åˆ«å…¶ä»–ç±»å‹çš„å‘½ä»¤

4. **æ€§èƒ½å½±å“**
   - æä½çš„ CPU å’Œå†…å­˜å ç”¨
   - ä¸å½±å“ç»ˆç«¯å“åº”é€Ÿåº¦

---

## ğŸ”® æœªæ¥æ‰©å±•

### å¯èƒ½çš„å¢å¼ºåŠŸèƒ½

1. **Git å‘½ä»¤ç›‘å¬**
   - æ•è· `git` å‘½ä»¤
   - è®°å½•åˆ° Git å‘½ä»¤å†å²

2. **è‡ªå®šä¹‰å‘½ä»¤æ¨¡å¼**
   - å…è®¸ç”¨æˆ·é…ç½®è¦ç›‘å¬çš„å‘½ä»¤æ¨¡å¼
   - æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼

3. **å‘½ä»¤è¿‡æ»¤**
   - å…è®¸ç”¨æˆ·é…ç½®è¦æ’é™¤çš„å‘½ä»¤
   - æ”¯æŒé»‘åå•/ç™½åå•

4. **æ›´è¯¦ç»†çš„ç»Ÿè®¡**
   - æŒ‰åŒ…ç®¡ç†å™¨åˆ†ç±»ç»Ÿè®¡
   - æŒ‰æ—¶é—´æ®µç»Ÿè®¡
   - å¯¼å‡ºç»Ÿè®¡æŠ¥å‘Š

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [VS Code Terminal API](https://code.visualstudio.com/api/references/vscode-api#window)
- [Shell Integration](https://code.visualstudio.com/docs/terminal/shell-integration)
- [ç»ˆç«¯å‘½ä»¤ç›‘å¬åŠŸèƒ½å¯è¡Œæ€§åˆ†æ](./ç»ˆç«¯å‘½ä»¤ç›‘å¬åŠŸèƒ½å¯è¡Œæ€§åˆ†æ.md)

