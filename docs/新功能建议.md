# 脚本管家 - 新功能建议

基于当前扩展的核心功能，以下是 5 个有价值的新功能建议，按优先级排序。

---

## 🏆 建议 1：脚本执行历史记录

### **功能名称**
最近执行的脚本历史记录

### **解决的问题**
**用户痛点：**
- 开发过程中经常需要重复执行相同的脚本（如 `dev`、`build`、`test`）
- 每次都要在脚本列表中查找，效率低下
- 收藏夹适合长期常用脚本，但有些脚本只是临时频繁使用
- 在大型项目中，脚本列表很长，查找耗时

**场景示例：**
```
开发流程：
1. 运行 dev 启动开发服务器
2. 修改代码
3. 运行 test 测试
4. 运行 lint 检查代码
5. 再次运行 dev（需要重新在列表中找）
```

### **实现思路**

**涉及文件：**
- `src/historyManager.ts`（新建）- 历史记录管理
- `src/historyTreeProvider.ts`（新建）- 历史视图提供者
- `src/extension.ts` - 集成历史功能
- `package.json` - 添加历史视图配置

**核心实现：**
```typescript
// historyManager.ts
export class HistoryManager {
    private history: NpmScript[] = [];
    private maxHistorySize = 10;
    
    async addToHistory(script: NpmScript): Promise<void> {
        // 移除重复项
        this.history = this.history.filter(s => 
            this.getScriptKey(s) !== this.getScriptKey(script)
        );
        
        // 添加到开头
        this.history.unshift(script);
        
        // 限制数量
        if (this.history.length > this.maxHistorySize) {
            this.history = this.history.slice(0, this.maxHistorySize);
        }
        
        await this.saveHistory();
    }
}
```

**UI 设计：**
```
📦 脚本管家

最近执行                    🕒
├─ 📄 dev (2分钟前)         ▶️
├─ 📄 test (5分钟前)        ▶️
└─ 📄 build (10分钟前)      ▶️

收藏夹                      ⭐
脚本列表                    🔄 🔍
```

### **优先级**
**⭐⭐⭐⭐⭐ 高优先级**

**原因：**
- ✅ 实现简单（1-2天开发）
- ✅ 用户价值极高（显著提升效率）
- ✅ 不影响现有功能
- ✅ 所有用户都能受益

### **用户价值**

**效率提升：**
- 🚀 **节省时间**：无需在长列表中查找，点击即可重新执行
- 🎯 **减少操作**：从"查找 → 点击"变为"直接点击"
- 💡 **智能排序**：最近使用的自动排在前面

**具体收益：**
- 每次重复执行脚本节省 3-5 秒
- 每天执行 20 次脚本，节省 1-2 分钟
- 一年节省约 6-12 小时

---

## 🎯 建议 2：脚本组合与工作流

### **功能名称**
脚本工作流（Script Workflow）- 组合多个脚本按顺序执行

### **解决的问题**

**用户痛点：**
- 复杂项目需要按顺序执行多个脚本
- 每次都要手动一个个执行，容易遗漏步骤
- 无法保证执行顺序的一致性
- 团队成员可能不清楚正确的执行流程

**典型场景：**
```
部署流程：
1. npm run clean      (清理旧文件)
2. npm run build      (构建项目)
3. npm run test       (运行测试)
4. npm run deploy     (部署)

每次都要手动执行4次，容易出错
```

### **实现思路**

**涉及文件：**
- `src/workflowManager.ts`（新建）- 工作流管理
- `src/workflowTreeProvider.ts`（新建）- 工作流视图
- `src/workflowExecutor.ts`（新建）- 工作流执行器
- `package.json` - 添加工作流配置

**核心实现：**
```typescript
// workflowManager.ts
interface Workflow {
    id: string;
    name: string;
    description?: string;
    steps: WorkflowStep[];
}

interface WorkflowStep {
    scriptName: string;
    packageJsonPath: string;
    mode: 'serial' | 'parallel';  // 串行或并行
    continueOnError?: boolean;     // 失败后是否继续
}

export class WorkflowManager {
    async executeWorkflow(workflow: Workflow): Promise<void> {
        for (const step of workflow.steps) {
            if (step.mode === 'serial') {
                await this.executeStep(step);
            } else {
                // 并行执行
                this.executeStepAsync(step);
            }
        }
    }
}
```

**UI 设计：**
```
📦 脚本管家

工作流                      ⚡
├─ 🔄 完整部署流程          ▶️
│   ├─ 1. clean
│   ├─ 2. build
│   ├─ 3. test
│   └─ 4. deploy
└─ 🔄 快速测试              ▶️
    ├─ 1. lint
    └─ 2. test

右键菜单：
- ▶️  执行工作流
- ✏️  编辑工作流
- ❌  删除工作流
```

**创建工作流界面：**
```
命令面板：
> 脚本管家: 创建工作流

步骤1: 输入工作流名称
步骤2: 选择要包含的脚本（多选）
步骤3: 调整执行顺序
步骤4: 配置执行模式（串行/并行）
```

### **优先级**
**⭐⭐⭐⭐⭐ 高优先级**

**原因：**
- ✅ 用户价值极高（解决复杂项目的核心痛点）
- ⚠️ 实现复杂度中等（3-5天开发）
- ✅ 差异化功能（市场上少见）
- ✅ 适合团队协作

### **用户价值**

**效率提升：**
- 🚀 **自动化流程**：一键执行多个步骤，无需人工干预
- 🎯 **减少错误**：避免遗漏步骤或执行顺序错误
- 📋 **标准化流程**：团队统一执行流程，提升协作效率
- ⏱️ **节省时间**：复杂流程从 5 分钟减少到 10 秒

**具体收益：**
- 部署流程从手动 5 分钟 → 自动 10 秒
- 减少 90% 的人为错误
- 新成员快速上手（无需记忆复杂流程）

---

## 📊 建议 3：脚本执行状态与通知

### **功能名称**
实时执行状态显示和完成通知

### **解决的问题**

**用户痛点：**
- 脚本在后台运行时，不知道执行状态
- 长时间运行的脚本（如构建）完成时，用户可能没注意到
- 需要频繁切换到终端查看进度
- 脚本失败时没有明显提示

**场景示例：**
```
用户启动 build 脚本（需要 5 分钟）
→ 切换到其他窗口工作
→ 5 分钟后不知道构建是否完成
→ 需要手动切回终端查看
```

### **实现思路**

**涉及文件：**
- `src/scriptExecutor.ts` - 添加状态监听
- `src/scriptsTreeProvider.ts` - 显示状态图标
- `src/types.ts` - 添加状态类型定义

**核心实现：**
```typescript
// types.ts
enum ScriptStatus {
    IDLE = 'idle',
    RUNNING = 'running',
    SUCCESS = 'success',
    FAILED = 'failed'
}

// scriptExecutor.ts
export class ScriptExecutor {
    private scriptStatus: Map<string, ScriptStatus> = new Map();
    
    async executeScript(script: NpmScript): Promise<void> {
        this.setStatus(script, ScriptStatus.RUNNING);
        const startTime = Date.now();
        
        // 监听终端退出
        terminal.processId.then(pid => {
            // 监听进程退出
            this.watchProcess(pid, (exitCode) => {
                const duration = Date.now() - startTime;
                
                if (exitCode === 0) {
                    this.setStatus(script, ScriptStatus.SUCCESS);
                    this.showNotification(script, duration, true);
                } else {
                    this.setStatus(script, ScriptStatus.FAILED);
                    this.showNotification(script, duration, false);
                }
            });
        });
    }
    
    private showNotification(script: NpmScript, duration: number, success: boolean): void {
        const time = this.formatDuration(duration);
        const message = success 
            ? `✅ "${script.name}" 执行成功 (${time})`
            : `❌ "${script.name}" 执行失败 (${time})`;
        
        vscode.window.showInformationMessage(message);
    }
}
```

**UI 设计：**
```
脚本列表
├─ 📄 dev                   ▶️
├─ 🔄 build (运行中...)     ⏸️  [进度条: 45%]
├─ ✅ test (成功 - 2.3s)    ▶️
└─ ❌ lint (失败 - 1.1s)    ▶️

状态图标：
🔄 - 运行中
✅ - 成功
❌ - 失败
📄 - 未运行
```

**通知示例：**
```
桌面通知：
┌─────────────────────────────┐
│ 脚本管家                     │
│ ✅ "build" 执行成功 (3分12秒) │
│ [查看输出] [关闭]            │
└─────────────────────────────┘
```

### **优先级**
**⭐⭐⭐⭐ 中高优先级**

**原因：**
- ✅ 用户价值高（提升用户体验）
- ⚠️ 实现复杂度中等（需要监听进程）
- ✅ 视觉反馈明显
- ⚠️ 对短时间脚本价值较低

### **用户价值**

**体验提升：**
- 👀 **实时反馈**：随时了解脚本执行状态
- 🔔 **及时通知**：脚本完成立即知晓，无需等待
- ⏱️ **时间感知**：显示执行时长，优化性能
- 🎯 **快速定位**：失败脚本一目了然

**具体收益：**
- 减少 80% 的终端切换次数
- 长时间脚本完成后立即响应
- 提升多任务处理效率

---

## ⌨️ 建议 4：快捷键绑定与快速执行

### **功能名称**
为常用脚本绑定快捷键，支持快速选择面板

### **解决的问题**

**用户痛点：**
- 频繁使用的脚本每次都要用鼠标点击
- 键盘流用户希望全键盘操作
- 在编辑器和侧边栏之间切换效率低
- 需要快速启动/停止脚本

**场景示例：**
```
开发流程（当前）：
1. 鼠标移到侧边栏
2. 找到"脚本管家"图标
3. 点击展开
4. 找到 dev 脚本
5. 点击执行

理想流程：
1. 按 Ctrl+Shift+R
2. 输入 "dev"
3. 回车执行
```

### **实现思路**

**涉及文件：**
- `package.json` - 注册命令和快捷键
- `src/extension.ts` - 实现快速选择命令
- `src/keybindingManager.ts`（新建）- 管理快捷键

**核心实现：**
```typescript
// extension.ts
const quickRunCommand = vscode.commands.registerCommand(
    'scriptButler.quickRun',
    async () => {
        const allScripts = scriptsTreeProvider.getAllScripts();

        // 创建快速选择项
        const items = allScripts.map(script => ({
            label: `$(terminal) ${script.name}`,
            description: script.command,
            detail: script.packageJsonPath,
            script: script
        }));

        // 显示快速选择面板
        const selected = await vscode.window.showQuickPick(items, {
            placeHolder: '选择要执行的脚本...',
            matchOnDescription: true,
            matchOnDetail: true
        });

        if (selected) {
            await scriptExecutor.executeScript(selected.script);
        }
    }
);
```

**package.json 配置：**
```json
{
  "contributes": {
    "commands": [
      {
        "command": "scriptButler.quickRun",
        "title": "快速执行脚本"
      }
    ],
    "keybindings": [
      {
        "command": "scriptButler.quickRun",
        "key": "ctrl+shift+r",
        "mac": "cmd+shift+r"
      },
      {
        "command": "scriptButler.stopRunning",
        "key": "ctrl+shift+x",
        "mac": "cmd+shift+x"
      }
    ],
    "configuration": {
      "properties": {
        "scriptButler.favoriteKeybindings": {
          "type": "object",
          "description": "为收藏的脚本绑定快捷键",
          "default": {}
        }
      }
    }
  }
}
```

**UI 设计：**
```
快速选择面板（Ctrl+Shift+R）：
┌─────────────────────────────────────┐
│ > dev_                               │
├─────────────────────────────────────┤
│ $(terminal) dev                      │
│   vite                               │
│   d:\project\package.json            │
├─────────────────────────────────────┤
│ $(terminal) dev:server               │
│   node server.js                     │
│   d:\project\package.json            │
└─────────────────────────────────────┘
```

### **优先级**
**⭐⭐⭐⭐ 中高优先级**

**原因：**
- ✅ 实现简单（1-2天开发）
- ✅ 键盘流用户价值极高
- ✅ 符合 VS Code 使用习惯
- ⚠️ 鼠标用户价值较低

### **用户价值**

**效率提升：**
- ⚡ **极速执行**：2 秒内完成脚本选择和执行
- ⌨️ **全键盘操作**：无需鼠标，提升专注度
- 🎯 **模糊搜索**：快速定位目标脚本
- 🔄 **快速切换**：在编辑器和脚本执行间无缝切换

**具体收益：**
- 执行脚本时间从 5 秒 → 2 秒
- 键盘流用户效率提升 60%
- 减少鼠标使用，降低手腕疲劳

---

## 🎨 建议 5：脚本参数输入支持

### **功能名称**
动态参数输入 - 执行脚本时传递自定义参数

### **解决的问题**

**用户痛点：**
- 很多脚本需要参数（如 `build --mode=production`）
- 当前只能执行固定命令，无法动态传参
- 需要为不同参数组合创建多个脚本
- package.json 变得臃肿

**场景示例：**
```json
// 当前做法：为每种参数组合创建脚本
{
  "scripts": {
    "build": "vite build",
    "build:prod": "vite build --mode=production",
    "build:dev": "vite build --mode=development",
    "build:staging": "vite build --mode=staging"
  }
}

// 理想做法：一个脚本 + 动态参数
{
  "scripts": {
    "build": "vite build"
  }
}
// 执行时输入: --mode=production
```

### **实现思路**

**涉及文件：**
- `src/scriptExecutor.ts` - 添加参数输入逻辑
- `src/types.ts` - 添加参数配置类型
- `package.json` - 添加参数配置

**核心实现：**
```typescript
// scriptExecutor.ts
export class ScriptExecutor {
    async executeScript(script: NpmScript, withParams: boolean = false): Promise<void> {
        let command = this.getRunCommand(script);

        if (withParams) {
            // 显示参数输入框
            const params = await vscode.window.showInputBox({
                prompt: `为 "${script.name}" 输入参数`,
                placeHolder: '例如: --mode=production --verbose',
                value: this.getLastParams(script) // 记住上次的参数
            });

            if (params) {
                command += ` ${params}`;
                this.saveLastParams(script, params);
            } else {
                return; // 用户取消
            }
        }

        terminal.sendText(command);
    }

    // 保存常用参数组合
    private savedParams: Map<string, string[]> = new Map();

    async showParamPresets(script: NpmScript): Promise<string | undefined> {
        const presets = this.savedParams.get(this.getScriptKey(script)) || [];

        const items = [
            { label: '$(edit) 自定义输入...', value: 'custom' },
            ...presets.map(p => ({ label: p, value: p }))
        ];

        const selected = await vscode.window.showQuickPick(items, {
            placeHolder: '选择参数或自定义输入'
        });

        if (selected?.value === 'custom') {
            return await vscode.window.showInputBox({...});
        }

        return selected?.value;
    }
}
```

**UI 设计：**
```
右键菜单：
├─ ▶️  运行脚本
├─ ⚙️  运行脚本（带参数）    ← 新增
├─ ⭐  添加到收藏夹
└─ ...

参数输入框：
┌─────────────────────────────────────┐
│ 为 "build" 输入参数                  │
├─────────────────────────────────────┤
│ --mode=production_                   │
│                                      │
│ 常用参数：                           │
│ • --mode=production                  │
│ • --mode=development                 │
│ • --verbose                          │
└─────────────────────────────────────┘
```

### **优先级**
**⭐⭐⭐ 中优先级**

**原因：**
- ✅ 实现简单（1-2天开发）
- ⚠️ 不是所有项目都需要
- ✅ 对需要传参的项目很有用
- ⚠️ 可以通过创建多个脚本变通解决

### **用户价值**

**灵活性提升：**
- 🎯 **动态配置**：一个脚本支持多种参数组合
- 📦 **简化配置**：减少 package.json 中的脚本数量
- 💾 **记忆功能**：记住常用参数，快速复用
- 🔄 **快速切换**：不同环境间快速切换

**具体收益：**
- package.json 脚本数量减少 50%
- 配置更清晰，易于维护
- 支持临时参数，无需修改配置

---

## 📊 功能优先级总结

| 功能 | 优先级 | 实现难度 | 用户价值 | 推荐指数 |
|------|--------|---------|---------|---------|
| 1. 执行历史记录 | ⭐⭐⭐⭐⭐ | 简单 | 极高 | 🏆🏆🏆🏆🏆 |
| 2. 脚本工作流 | ⭐⭐⭐⭐⭐ | 中等 | 极高 | 🏆🏆🏆🏆🏆 |
| 3. 执行状态通知 | ⭐⭐⭐⭐ | 中等 | 高 | 🏆🏆🏆🏆 |
| 4. 快捷键绑定 | ⭐⭐⭐⭐ | 简单 | 高 | 🏆🏆🏆🏆 |
| 5. 参数输入 | ⭐⭐⭐ | 简单 | 中 | 🏆🏆🏆 |

---

## 🚀 实施建议

### 第一阶段（MVP）
**目标：快速提升用户体验**
- ✅ 功能 1：执行历史记录（1-2天）
- ✅ 功能 4：快捷键绑定（1-2天）

**预期效果：**
- 开发时间：3-4天
- 用户价值：显著提升日常使用效率

### 第二阶段（增强）
**目标：解决复杂场景**
- ✅ 功能 2：脚本工作流（3-5天）
- ✅ 功能 3：执行状态通知（2-3天）

**预期效果：**
- 开发时间：5-8天
- 用户价值：支持复杂项目和团队协作

### 第三阶段（完善）
**目标：锦上添花**
- ✅ 功能 5：参数输入（1-2天）
- ✅ 其他优化和 bug 修复

---

## 💡 额外建议

### 其他可考虑的功能
1. **脚本依赖关系图** - 可视化脚本间的依赖关系
2. **性能分析** - 记录和对比脚本执行时间
3. **团队共享配置** - 通过 Git 共享工作流和收藏
4. **脚本模板** - 快速创建常用脚本
5. **环境变量管理** - 为不同脚本设置环境变量

---

**总结：建议优先实现"执行历史记录"和"快捷键绑定"，这两个功能实现简单、用户价值高，能快速提升扩展的竞争力。**


