# 多行命令输入体验优化

## 🐛 问题描述

**现象：**
在使用"文本输入"模式创建工作流时，用户无法在编辑器中输入内容。

**错误的流程：**
1. 选择"文本输入"模式创建工作流
2. 系统打开一个临时编辑器文件
3. **同时**弹出一个模态对话框，显示：
   - 提示文本："在编辑器中输入命令序列（每行一个命令），完成后点击"确定""
   - 两个按钮："确定" 和 "取消"
4. ❌ **问题：** 当这个模态对话框存在时，用户无法在编辑器中输入内容（焦点被对话框锁定）
5. ❌ 如果用户点击"确定"，编辑器内容会被保存，但此时用户还没有机会输入任何内容

---

## 🔍 问题分析

### 原始代码（src/workflowCreator.ts，第 189-222 行）

**问题代码：**
```typescript
async showMultilineInput(
    prompt: string,
    placeHolder: string,
    defaultValue?: string
): Promise<string | undefined> {
    // 创建一个临时文档来输入多行文本
    const doc = await vscode.workspace.openTextDocument({
        content: defaultValue || '',
        language: 'shellscript'
    });

    const editor = await vscode.window.showTextDocument(doc, {
        preview: true,
        viewColumn: vscode.ViewColumn.Beside
    });

    // ❌ 问题：立即显示模态对话框，阻塞用户输入
    const result = await vscode.window.showInformationMessage(
        prompt,
        { modal: true },  // ← 模态对话框会锁定焦点
        '确定',
        '取消'
    );

    const content = editor.document.getText();

    // 关闭临时文档
    await vscode.commands.executeCommand('workbench.action.closeActiveEditor');

    if (result === '确定') {
        return content;
    }

    return undefined;
}
```

**问题原因：**
1. **模态对话框阻塞编辑器**
   - `{ modal: true }` 会创建一个模态对话框
   - 模态对话框会锁定焦点，用户无法切换到编辑器
   - 用户必须先点击"确定"或"取消"才能继续

2. **时序错误**
   - 打开编辑器后立即显示对话框
   - 用户还没有机会输入内容
   - 点击"确定"时，编辑器内容仍然是默认值

3. **用户体验差**
   - 用户看到编辑器打开，但无法输入
   - 必须先关闭对话框，但关闭后工作流创建就取消了
   - 陷入死循环：无法输入 → 无法创建

---

## ✅ 解决方案

### 设计思路

**改用事件驱动的方式：**
1. 打开编辑器，让用户立即可以输入
2. 显示**非模态**提示信息，告诉用户如何操作
3. 监听**文件保存事件**，保存后自动读取内容
4. 监听**编辑器关闭事件**，关闭时取消创建
5. 使用 `Promise` 来等待用户操作

---

### 修复后的代码（src/workflowCreator.ts，第 185-253 行）

```typescript
/**
 * 显示多行文本输入对话框
 * 使用文件保存事件来触发内容读取，避免模态对话框阻塞编辑器
 */
async showMultilineInput(
    prompt: string,
    placeHolder: string,
    defaultValue?: string
): Promise<string | undefined> {
    // 创建一个临时文档来输入多行文本
    const doc = await vscode.workspace.openTextDocument({
        content: defaultValue || '',
        language: 'shellscript'
    });

    const editor = await vscode.window.showTextDocument(doc, {
        preview: false,  // ✅ 不使用预览模式，避免被意外关闭
        viewColumn: vscode.ViewColumn.Beside
    });

    // ✅ 显示非模态提示信息（状态栏消息）
    const statusBarMessage = vscode.window.setStatusBarMessage(
        '$(edit) 请在编辑器中输入命令序列，保存文件 (Ctrl+S) 后将自动创建工作流',
        10000  // 10 秒后自动消失
    );

    // ✅ 也显示一个信息提示（非模态）
    vscode.window.showInformationMessage(
        '请在编辑器中输入命令序列（每行一个命令），保存文件后将自动创建工作流。关闭编辑器将取消创建。'
    );

    // ✅ 等待用户保存文件或关闭编辑器
    return new Promise<string | undefined>((resolve) => {
        let resolved = false;

        // ✅ 监听文档保存事件
        const saveDisposable = vscode.workspace.onDidSaveTextDocument((savedDoc) => {
            if (savedDoc === doc && !resolved) {
                resolved = true;
                const content = savedDoc.getText();
                
                // 清理事件监听器
                saveDisposable.dispose();
                closeDisposable.dispose();
                statusBarMessage.dispose();
                
                // 关闭编辑器
                vscode.commands.executeCommand('workbench.action.closeActiveEditor');
                
                resolve(content);
            }
        });

        // ✅ 监听编辑器关闭事件
        const closeDisposable = vscode.window.onDidChangeVisibleTextEditors((editors) => {
            // 检查编辑器是否已关闭
            if (!editors.includes(editor) && !resolved) {
                resolved = true;
                
                // 清理事件监听器
                saveDisposable.dispose();
                closeDisposable.dispose();
                statusBarMessage.dispose();
                
                resolve(undefined);
            }
        });
    });
}
```

---

### 关键改进

#### **1. 移除模态对话框**
```typescript
// ❌ 原来：模态对话框阻塞编辑器
const result = await vscode.window.showInformationMessage(
    prompt,
    { modal: true },
    '确定',
    '取消'
);

// ✅ 现在：非模态提示信息
vscode.window.showInformationMessage(
    '请在编辑器中输入命令序列（每行一个命令），保存文件后将自动创建工作流。关闭编辑器将取消创建。'
);
```

#### **2. 添加状态栏消息**
```typescript
const statusBarMessage = vscode.window.setStatusBarMessage(
    '$(edit) 请在编辑器中输入命令序列，保存文件 (Ctrl+S) 后将自动创建工作流',
    10000  // 10 秒后自动消失
);
```

#### **3. 监听文件保存事件**
```typescript
const saveDisposable = vscode.workspace.onDidSaveTextDocument((savedDoc) => {
    if (savedDoc === doc && !resolved) {
        resolved = true;
        const content = savedDoc.getText();
        
        // 清理并返回内容
        saveDisposable.dispose();
        closeDisposable.dispose();
        statusBarMessage.dispose();
        
        vscode.commands.executeCommand('workbench.action.closeActiveEditor');
        
        resolve(content);
    }
});
```

#### **4. 监听编辑器关闭事件**
```typescript
const closeDisposable = vscode.window.onDidChangeVisibleTextEditors((editors) => {
    if (!editors.includes(editor) && !resolved) {
        resolved = true;
        
        // 清理并取消创建
        saveDisposable.dispose();
        closeDisposable.dispose();
        statusBarMessage.dispose();
        
        resolve(undefined);
    }
});
```

#### **5. 使用 Promise 等待用户操作**
```typescript
return new Promise<string | undefined>((resolve) => {
    // 设置事件监听器
    // 等待用户保存或关闭
});
```

---

## 📊 用户体验对比

### 修复前的流程

```
1. 用户选择"文本输入"模式
   ↓
2. 系统打开编辑器
   ↓
3. 系统立即显示模态对话框 ❌
   ├─ 用户无法在编辑器中输入
   ├─ 焦点被对话框锁定
   └─ 用户陷入困境
   ↓
4. 用户点击"确定"
   ├─ 编辑器内容为空（默认值）
   └─ 创建失败或创建空工作流 ❌
```

---

### 修复后的流程

```
1. 用户选择"文本输入"模式
   ↓
2. 系统打开编辑器
   ↓
3. 系统显示非模态提示 ✅
   ├─ 状态栏消息："请在编辑器中输入命令序列，保存文件 (Ctrl+S) 后将自动创建工作流"
   └─ 信息提示："请在编辑器中输入命令序列（每行一个命令），保存文件后将自动创建工作流。关闭编辑器将取消创建。"
   ↓
4. 用户在编辑器中输入命令 ✅
   ├─ npm run clean
   ├─ npm run build
   └─ npm run test
   ↓
5. 用户保存文件 (Ctrl+S) ✅
   ↓
6. 系统自动读取内容并创建工作流 ✅
   ├─ 关闭编辑器
   ├─ 显示预览对话框
   └─ 确认创建
```

---

## ✅ 编译验证

```bash
npm run compile
```

**结果：**
- ✅ 编译成功
- ✅ 无诊断错误

---

## 🧪 测试步骤

### 测试 1：正常创建工作流

1. 打开"脚本管家"侧边栏
2. 点击"工作流"视图的 ➕ 按钮
3. 输入工作流名称："测试工作流"
4. 输入描述（可选）
5. 选择"$(edit) 文本输入"模式
6. 观察编辑器打开
7. 观察状态栏消息和信息提示
8. 在编辑器中输入命令：
   ```
   npm run clean
   npm run build
   npm run test
   ```
9. 保存文件 (Ctrl+S 或 Cmd+S)
10. 观察预览对话框
11. 点击"确定"

**预期结果：**
- ✅ 编辑器打开后，用户可以立即输入内容
- ✅ 状态栏显示提示消息
- ✅ 信息提示显示操作说明
- ✅ 保存文件后，编辑器自动关闭
- ✅ 显示预览对话框，包含 3 个步骤
- ✅ 工作流创建成功

---

### 测试 2：取消创建工作流

1. 重复测试 1 的步骤 1-7
2. 在编辑器中输入一些内容（或不输入）
3. **不保存文件**，直接关闭编辑器 (Ctrl+W 或点击关闭按钮)

**预期结果：**
- ✅ 编辑器关闭
- ✅ 工作流创建被取消
- ✅ 不显示预览对话框
- ✅ 不创建工作流

---

### 测试 3：输入空内容

1. 重复测试 1 的步骤 1-7
2. 不输入任何内容（或只输入注释）
3. 保存文件 (Ctrl+S)

**预期结果：**
- ✅ 编辑器关闭
- ✅ 显示警告："没有有效的命令"
- ✅ 工作流创建被取消

---

### 测试 4：输入带注释的命令

1. 重复测试 1 的步骤 1-7
2. 在编辑器中输入：
   ```
   # 清理构建产物
   npm run clean
   
   # 构建项目
   npm run build
   
   # 运行测试
   npm run test
   ```
3. 保存文件 (Ctrl+S)

**预期结果：**
- ✅ 编辑器关闭
- ✅ 显示预览对话框，包含 3 个步骤（注释被忽略）
- ✅ 工作流创建成功

---

## 🎉 总结

**问题：** 文本输入模式下，模态对话框阻塞编辑器，用户无法输入内容

**原因：** 打开编辑器后立即显示模态对话框，锁定焦点

**解决方案：** 
- ✅ 移除模态对话框
- ✅ 使用非模态提示信息
- ✅ 监听文件保存事件
- ✅ 监听编辑器关闭事件
- ✅ 使用 Promise 等待用户操作

**修复内容：**
- ✅ 重写 `showMultilineInput()` 方法
- ✅ 添加状态栏消息提示
- ✅ 添加非模态信息提示
- ✅ 实现事件驱动的内容读取
- ✅ 改进用户体验流程

**验证结果：**
- ✅ 编译成功
- ✅ 用户可以立即在编辑器中输入
- ✅ 保存文件后自动创建工作流
- ✅ 关闭编辑器可以取消创建
- ✅ 用户体验流畅自然

**现在文本输入模式的用户体验完美了！** 🚀

